üìå FULL CODE AUDIT & PERMANENT FIX INSTRUCTIONS

1Ô∏è‚É£ Context & Non-Negotiable Constraints
1.1 Data Sources (Single Source of Truth)
‚Ä¢	Yahoo Finance API
o	Used for:
ÔÇß	Stocks
ÔÇß	ETFs
ÔÇß	Options Chains
‚Ä¢	MarketAux API
o	Used ONLY for market news
‚Ä¢	‚ùå No mixing, fallback, inferred pricing, or synthetic data from any other source

2Ô∏è‚É£ Core Problems Identified
2.1 Cross-Page Impact Bug
Issue
Fixes applied to one page (e.g. Screener or Simulator) are unintentionally impacting:
‚Ä¢	Watchlist prices
‚Ä¢	Pre-computed scans
‚Ä¢	PMCC / CC trackers
Root Cause
‚Ä¢	Shared pricing utilities
‚Ä¢	Global mutable state
‚Ä¢	No separation between:
o	Live pricing
o	Snapshot pricing
o	Cached / pre-computed pricing
Required Fix
Introduce explicit pricing context isolation:
‚Ä¢	LiveMarketContext
‚Ä¢	AfterHoursContext
‚Ä¢	SnapshotContext (Simulator / Watchlist snapshots / Pre-computed scans)
üö´ No default context
‚úÖ Every price fetch must explicitly declare its context


3Ô∏è‚É£ Market Hours Logic (CRITICAL FIX)
3.1 Market Time Definitions (ET)
Time	Expected Behaviour
9:30 AM ‚Äì 4:00 PM ET	Market Open
4:00 PM ‚Äì 4:15 PM ET	After-Hours (same day)
After 4:05 PM ET	Market Closed
‚ö†Ô∏è Example: 4:05 PM ET is still SAME-DAY logic, never ‚Äúnext day‚Äù or blank.



3.2 DO NOT Block Execution When Market Is Open ‚ùå
Current Wrong Logic
‚Ä¢	Cron / backend logic assumes execution only after market close
‚Ä¢	Result: blank dashboards, missing scans, missing prices intraday
Correct Rule
‚Ä¢	Logic MUST ALWAYS RUN
‚Ä¢	Only price selection rules change based on market state

4Ô∏è‚É£ Stock & ETF Price Rules (FINAL)
4.1 Market OPEN
price = regularMarketPrice
timestamp = regularMarketTime
4.2 After 4:05 PM ET (Same Day)
price = postMarketPrice IF available
ELSE price = regularMarketPrice
timestamp = max(regularMarketTime, postMarketTime)
4.3 Weekends / US Public Holidays
price = lastRegularMarketClose
timestamp = lastRegularMarketTime


5Ô∏è‚É£ Options Chain Fetching ‚Äì Correct Logic
5.1 Yahoo Finance Reality Check
‚Ä¢	‚ùå Yahoo does NOT provide Delta
‚Ä¢	‚ùå Yahoo does NOT guarantee intraday greeks
‚Ä¢	‚úîÔ∏è Yahoo provides:
o	Bid
o	Ask
o	LastPrice
o	Implied Volatility
o	Volume / Open Interest

5.2 Options Chain Fetching Rules
Market Open
‚Ä¢	Fetch latest available chain
‚Ä¢	Never reject chain just because market is open
After Market Close (‚â• 4:05 PM ET)
‚Ä¢	Fetch same-day chain
‚Ä¢	Accept slight staleness
‚Ä¢	‚ùå No next-day inference
Weekends/Holidays
‚Ä¢	Use last trading day chain
‚Ä¢	Mark explicitly: stale = true




To keep the user from getting confused during holidays or weekends, use this hierarchy:

Period	Stock Price Source	Option Price Source	UI Label
Market Hours	Live (Last)	Live (Mid)	‚óè LIVE
After-Hours	Last (at 4:05 PM)	Last (at 4:05 PM)	‚óè MARKET CLOSED (EOD)
Weekend/Holiday	Last (on Friday 4:05 PM)	Last (on Friday 4:05 PM)	‚óè MARKET CLOSED (EOD)

Component	Price Source for Scans	Price Source for P/L Tracking
Long Call Leg	Ask_Price	(Bid + Ask) / 2 (Mid)
Short Call Leg	Bid_Price	(Bid + Ask) / 2 (Mid)
Stock/ETF Price	Last_Price	Last_Price

Master Price Fetching Logic
Module	Market State	Stock Price Source	Option Leg Source (Long/Short)	Logic Purpose
Pre-Computed Scan	Closed	Previous Market Close (PMC)	At Close - Long: PMC Ask Close / Short: PMC Bid Close	Pre-calculates setups overnight using the final "synced" state of the market.
Live Scan	Open	Latest Snapshot (Last)	Latest - Long: Snapshot Ask / Short: Snapshot Bid	Ensures a trade is still viable at current "natural" fill prices before entry.
Simulator (Entry)	Open	Latest Snapshot (Last)	Latest - Long: Entry Ask / Short: Entry Bid	Records your "Slippage." You start the trade with a small loss representing the spread.
Simulator (Entry)	Closed	Previous Market Close (PMC)	At Close - Long: PMC Ask / Short: PMC Bid	Allows users to "Paper Trade" on weekends using the most recent valid data.
Watchlist (Live)	Open	Live Stream (Last)	Both Legs: Live Mid Price	Prevents "P/L flickering." Uses Fair Value so the user sees true movement.
Watchlist (Static)	Closed	Previous Market Close (PMC)	Both Legs: PMC Mid Price	Locks the P/L at the final "Mark" of the day to avoid After-Hours stock price noise.

NOTE: Mid Price = (Bid Price + Ask Price) / 2

6Ô∏è‚É£ Options Pricing Rules (MANDATORY)
6.1 Price Selection
Leg	Use
Long (Buy)	ASK
Short (Sell)	BID
‚ùå Never use:
‚Ä¢	Mid prices
‚Ä¢	Last traded price
‚Ä¢	Synthetic averages

7Ô∏è‚É£ Delta Calculation ‚Äì FINAL DECISION
7.1 Validation
‚Ä¢	Yahoo Finance does NOT supply Delta
‚Ä¢	Any existing Delta is invalid or inferred

7.2 Chosen Approach (APPROVED)
‚úÖ Black-Scholes Formula ONLY

7.3 Black-Scholes Delta Formula
Inputs:
‚Ä¢	S = Current stock price
‚Ä¢	K = Strike price
‚Ä¢	T = Time to expiry (years)
‚Ä¢	r = Risk-free rate (configurable constant)
‚Ä¢	œÉ = Implied volatility (fallback allowed)
Formula:
d1 = [ ln(S / K) + (r + œÉ¬≤ / 2)T ] / (œÉ‚àöT)
Call Delta = N(d1)

7.4 Implementation Rules
‚Ä¢	Delta must be:
o	Calculated dynamically
o	Cached per option contract
‚Ä¢	If IV missing:
if option.IV is None or option.IV == 0:
    use_fallback_IV()
Fallback (Explicit & Logged)
Option A ‚Äì Historical Volatility (HV)
HV = StdDev( ln(Pt / Pt-1) ) √ó ‚àö252
üö´ Never silently fail

8Ô∏è‚É£ Covered Call (CC) & PMCC Logic
8.1 Covered Call (CC)
‚Ä¢	Underlying stock owned
‚Ä¢	Short call:
o	Market Cap > $2 Billion
o	Strike > current stock price
o	Expiry ‚â§ 45 days
o	Delta target configurable (e.g. 0.20‚Äì0.35)
o	OI (Open Interest) > 500
o	Bid-Ask Price Spread < 10%
o	IV Rank > 30%
o	Option Expiry Date < Earnings Date and Ex-Dividend Date
o	RSI between 40 and 60
o	Current Stock Price > SMA (Simple Moving Average) 50 and 200  

8.2 PMCC ‚Äì FINAL RULES
‚Ä¢	Market Cap > $2 Billion
‚Ä¢	Average Daily Volume > 1 Million shares 
‚Ä¢	IV Rank: > 20% but < 70% 
‚Ä¢	Earnings Date: Not within the next 30 days 
‚Ä¢	Trend: Stock Price is above its 200-day Moving Average 

Long LEAPS Call
‚Ä¢	Expiry: 12‚Äì24 months
‚Ä¢	Strike: Deep ITM
‚Ä¢	Delta ‚â• 0.70 ‚â§ 90
‚Ä¢	Price source: ASK
Short Call
‚Ä¢	Expiry between 30 - 45 days
‚Ä¢	Strike > long-leg strike
‚Ä¢	Delta ‚â• 0.15 and ‚â§ 0.30
‚Ä¢	Price source: BID
‚Ä¢	Expected Yield = 1-2% of the Leaps Cost
AI Management Rules (this is for user suggestion only)
‚Ä¢	Green Day (Stock Rises): If Short Delta hits 0.45, roll the call Up and Out for a credit.
‚Ä¢	Red Day (Stock Falls): If Long Delta hits 0.70, exit the entire position. Capital preservation is priority #1.
‚Ä¢	=IF((Current_Stock_Price - Long_Strike) > (Adjusted_Cost_Basis / 100), "PROFITABLE EXIT", "HOLD")
o	Adjusted Cost Basis=(Initial LEAPS Cost)‚àí(Total Net Premium Received)
‚Ä¢	Time Passes: If Short Call reaches 50% profit, buy it back and sell a new one for the next cycle.

9Ô∏è‚É£ Pre-Computed Scans vs Simulator vs Watchlist
9.1 Pre-Computed Scans
‚Ä¢	Executed by cron jobs
‚Ä¢	Use SnapshotContext
‚Ä¢	Prices:
o	Timestamped
o	Immutable once stored
9.2 Simulator
‚Ä¢	Uses SnapshotContext
‚Ä¢	Prices frozen at trade open
‚Ä¢	No live updates unless explicitly simulated
9.3 Watchlist
‚Ä¢	Uses LiveMarketContext
‚Ä¢	Prices refresh dynamically
‚Ä¢	‚ùå Must NOT inherit simulator or scan prices

üîü CRON JOBS ‚Äì REQUIRED CHANGES (NEW)
10.1 Cron Jobs MUST NEVER:
‚Ä¢	Assume market is closed
‚Ä¢	Block execution during market hours
‚Ä¢	Write into LiveMarketContext
‚Ä¢	Mutate existing snapshot data

10.2 Cron Execution Rules
All cron jobs must:
‚Ä¢	Always run on schedule
‚Ä¢	Detect market state at runtime
‚Ä¢	Explicitly declare:
context = SNAPSHOT
market_state = OPEN | CLOSED

10.3 Cron Job Responsibilities
Job Type	Allowed
Pre-computed scans	‚úÖ Yes
Strategy ranking	‚úÖ Yes
Cache warming (snapshot only)	‚úÖ Yes
Watchlist price refresh	‚ùå No
Live pricing writes	‚ùå No

10.4 Timestamp Discipline
Every cron-generated record must include:
‚Ä¢	price
‚Ä¢	timestamp
‚Ä¢	market_state
‚Ä¢	data_staleness flag
‚ùå Cron jobs must NEVER overwrite:
‚Ä¢	Simulator trade entry prices
‚Ä¢	Watchlist live prices
‚Ä¢	Previously stored snapshots

10.5 Failure Handling
‚Ä¢	If Yahoo Finance returns partial data:
o	Store record with:
o	valid = false
o	reason = "DATA_INCOMPLETE"
‚Ä¢	Never return empty rows or silent failures

11Ô∏è‚É£ Structural Refactor (MANDATORY)
Create explicit modules:
‚Ä¢	market_hours.py
‚Ä¢	price_context.py
‚Ä¢	options_pricing.py
‚Ä¢	greeks_black_scholes.py
‚Ä¢	cron_snapshot_runner.py

11.1 Mandatory Flags
Every price fetch must declare:
{
  "context": "LIVE | AFTER_HOURS | SNAPSHOT",
  "market_state": "OPEN | CLOSED",
  "timestamp_source": "REGULAR | POST | LAST_CLOSE"
}

‚úÖ Final Acceptance Criteria
‚Ä¢	No cross-page side effects
‚Ä¢	Valid data during market hours
‚Ä¢	Correct 4:05 PM ET handling
‚Ä¢	Yahoo Finance as sole pricing source
‚Ä¢	Delta computed via Black-Scholes only
‚Ä¢	CC & PMCC rules enforced
‚Ä¢	Cron jobs isolated to snapshot context
‚Ä¢	Automated test cases covering:
o	Market open
o	4:05 PM ET
o	Weekends
o	Cron execution during market hours

